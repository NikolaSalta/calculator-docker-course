# ═══════════════════════════════════════════════════════════════════════════
# nginx.compose.conf — конфигурация nginx для DOCKER COMPOSE режима
# ═══════════════════════════════════════════════════════════════════════════
#
# Отличие от nginx.conf:
# - В nginx.conf: proxy_pass http://calc-backend:8080
# - Здесь:        proxy_pass http://backend:8080
#
# Почему разные имена?
# 
# В manual режиме мы создаём контейнер с именем:
#   docker run --name calc-backend ...
# 
# В Docker Compose имя сервиса определяется в docker-compose.yml:
#   services:
#     backend:    ← ВОТ ЭТО ИМЯ
#       build: ./backend
#
# Docker Compose создаёт DNS-записи по именам сервисов, а не контейнеров.
# Поэтому nginx должен обращаться к "backend", а не "calc-backend".
# ═══════════════════════════════════════════════════════════════════════════


server {
    # Слушаем порт 8080 (non-privileged)
    listen 8080;
    server_name localhost;

    # ─────────────────────────────────────────────────────────────────────
    # SECURITY HEADERS
    # ─────────────────────────────────────────────────────────────────────
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy "strict-origin-when-cross-origin";
    
    # ─────────────────────────────────────────────────────────────────────
    # Статические файлы React
    # ─────────────────────────────────────────────────────────────────────
    location / {
        root /usr/share/nginx/html;
        index index.html;
        
        # try_files для SPA (Single Page Application)
        # Все несуществующие пути возвращают index.html
        # React Router обработает маршрутизацию на клиенте
        try_files $uri $uri/ /index.html;
    }
    
    # ─────────────────────────────────────────────────────────────────────
    # Проксирование API в backend
    # ─────────────────────────────────────────────────────────────────────
    location /api/ {
        # ВАЖНО: "backend" — имя сервиса в docker-compose.yml
        # НЕ "calc-backend"!
        proxy_pass http://backend:8080;
        
        # Передаём заголовки
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
