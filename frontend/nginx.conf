# ═══════════════════════════════════════════════════════════════════════════
# nginx.conf — конфигурация nginx для MANUAL режима
# ═══════════════════════════════════════════════════════════════════════════
#
# Что такое nginx?
# nginx (произносится "engine-x") — высокопроизводительный веб-сервер.
# В нашем случае nginx:
# 1. Отдаёт статические файлы React (HTML/CSS/JS)
# 2. Проксирует запросы /api/* в backend-контейнер
#
# УЛУЧШЕНИЯ БЕЗОПАСНОСТИ:
# - Добавлены security headers
# - Скрыта версия nginx
# - Ограничен размер тела запроса
# ═══════════════════════════════════════════════════════════════════════════


server {
    listen 80;
    server_name localhost;
    
    # ─────────────────────────────────────────────────────────────────────────
    # БЕЗОПАСНОСТЬ: Security Headers
    # ─────────────────────────────────────────────────────────────────────────
    
    # Скрыть версию nginx в заголовках ответа
    server_tokens off;
    
    # Защита от clickjacking (запрет встраивания в iframe)
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # Защита от MIME-sniffing
    add_header X-Content-Type-Options "nosniff" always;
    
    # Включить XSS-фильтр браузера
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Ограничить размер тела запроса (защита от DoS)
    client_max_body_size 1m;
    
    # ─────────────────────────────────────────────────────────────────────────
    # LOCATION / — статические файлы React
    # ─────────────────────────────────────────────────────────────────────────
    
    location / {
        root /usr/share/nginx/html;
        index index.html;
        
        # try_files для SPA (Single Page Application)
        try_files $uri $uri/ /index.html;
        
        # Кэширование статических файлов
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # ─────────────────────────────────────────────────────────────────────────
    # LOCATION /api/ — проксирование в backend
    # ─────────────────────────────────────────────────────────────────────────
    
    location /api/ {
        # ВАЖНО: "calc-backend" — имя контейнера в manual режиме
        # При запуске: docker run --name calc-backend ...
        proxy_pass http://calc-backend:8080;
        
        # Передаём заголовки
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Таймауты для API
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # ─────────────────────────────────────────────────────────────────────────
    # Health check endpoint для nginx
    # ─────────────────────────────────────────────────────────────────────────
    location /nginx-health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
