# ═══════════════════════════════════════════════════════════════════════════
# nginx.conf — конфигурация nginx для MANUAL режима
# ═══════════════════════════════════════════════════════════════════════════
#
# Что такое nginx?
# nginx (произносится "engine-x") — высокопроизводительный веб-сервер.
# Он может:
# - Раздавать статические файлы (HTML, CSS, JS, картинки)
# - Проксировать запросы на другие серверы (reverse proxy)
# - Балансировать нагрузку между серверами
# - Кешировать ответы
#
# В нашем случае nginx:
# 1. Отдаёт статические файлы React (HTML/CSS/JS)
# 2. Проксирует запросы /api/* в backend-контейнер
# ═══════════════════════════════════════════════════════════════════════════


# server — блок конфигурации виртуального сервера
# Один nginx может обслуживать много сайтов (виртуальных хостов)
server {
    
    # ─────────────────────────────────────────────────────────────────────
    # ОСНОВНЫЕ НАСТРОЙКИ
    # ─────────────────────────────────────────────────────────────────────
    
    # listen 8080 — слушать порт 8080 (non-privileged)
    listen 8080;
    
    # server_name — имя хоста (домен)
    # localhost — принимать запросы на localhost
    # В продакшене здесь был бы реальный домен: example.com
    server_name localhost;

    # ─────────────────────────────────────────────────────────────────────
    # SECURITY HEADERS
    # ─────────────────────────────────────────────────────────────────────
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy "strict-origin-when-cross-origin";
    
    
    # ─────────────────────────────────────────────────────────────────────
    # LOCATION / — статические файлы React
    # ─────────────────────────────────────────────────────────────────────
    
    # location — правило для определённого пути URL
    # location / — все запросы, начинающиеся с /
    # (но более специфичные location имеют приоритет)
    location / {
        
        # root — директория с файлами
        # /usr/share/nginx/html — стандартный путь для статики в nginx
        # Туда мы скопировали собранный React-билд
        root /usr/share/nginx/html;
        
        # index — файл по умолчанию для директории
        # Запрос на / вернёт /index.html
        index index.html;
        
        # try_files — попытаться найти файл в определённом порядке
        # 
        # $uri — запрошенный путь (например, /static/js/main.js)
        # $uri/ — путь как директория (например, /about/)
        # /index.html — если ничего не найдено, вернуть index.html
        #
        # Зачем /index.html в конце?
        # React — это SPA (Single Page Application)
        # Вся маршрутизация происходит на клиенте
        # Если пользователь перешёл на /calculator и обновил страницу,
        # nginx не найдёт файл /calculator и должен вернуть index.html
        # А React Router на клиенте отобразит правильный компонент
        try_files $uri $uri/ /index.html;
    }
    
    
    # ─────────────────────────────────────────────────────────────────────
    # LOCATION /api/ — проксирование в backend
    # ─────────────────────────────────────────────────────────────────────
    
    # location /api/ — запросы, начинающиеся с /api/
    # Более специфичный путь имеет приоритет над location /
    location /api/ {
        
        # proxy_pass — переслать запрос на другой сервер
        #
        # http://calc-backend:8080 — URL backend-сервера
        # 
        # calc-backend — имя контейнера в Docker-сети
        # Docker DNS автоматически резолвит это имя в IP-адрес контейнера
        #
        # :8080 — порт, на котором слушает Spring Boot
        #
        # ВАЖНО: В этом файле используется "calc-backend"
        # Это имя контейнера в manual режиме (--name calc-backend)
        proxy_pass http://calc-backend:8080;
        
        # proxy_set_header — установить HTTP-заголовки для проксируемого запроса
        #
        # Host $host — передать оригинальный Host-заголовок
        # Без этого backend получит Host: calc-backend:8080 вместо localhost
        proxy_set_header Host $host;
        
        # X-Real-IP — передать реальный IP клиента
        # Без этого backend увидит IP nginx-контейнера
        # $remote_addr — переменная nginx с IP клиента
        proxy_set_header X-Real-IP $remote_addr;
    }
}
