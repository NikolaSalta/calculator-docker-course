# ═══════════════════════════════════════════════════════════════════════════
# Dockerfile для Backend (Java Spring Boot)
# ═══════════════════════════════════════════════════════════════════════════
#
# Multi-stage build с улучшениями безопасности:
# - Запуск от непривилегированного пользователя
# - Минимальный финальный образ
# ═══════════════════════════════════════════════════════════════════════════


# ┌─────────────────────────────────────────────────────────────────────────┐
# │ ЭТАП 1: СБОРКА (builder)                                                │
# └─────────────────────────────────────────────────────────────────────────┘

FROM maven:3.9-eclipse-temurin-17 AS builder

WORKDIR /app

# Сначала копируем только pom.xml для кэширования зависимостей
COPY pom.xml .

# Скачиваем зависимости (этот слой кэшируется)
RUN mvn dependency:go-offline -B

# Копируем исходный код
COPY src ./src

# Компилируем
RUN mvn clean package -DskipTests -B


# ┌─────────────────────────────────────────────────────────────────────────┐
# │ ЭТАП 2: ЗАПУСК (runtime)                                                │
# └─────────────────────────────────────────────────────────────────────────┘

FROM eclipse-temurin:17-jre

# ═══════════════════════════════════════════════════════════════════════════
# БЕЗОПАСНОСТЬ: Создаём непривилегированного пользователя
# ═══════════════════════════════════════════════════════════════════════════
# 
# По умолчанию контейнеры запускаются от root.
# Это плохо: если приложение взломают, атакующий получит root-доступ.
# Создаём пользователя appuser без привилегий.
# ═══════════════════════════════════════════════════════════════════════════

RUN groupadd --gid 1001 appgroup && \
    useradd --uid 1001 --gid appgroup --shell /bin/sh appuser

WORKDIR /app

# Копируем JAR из builder
COPY --from=builder /app/target/*.jar app.jar

# Меняем владельца файлов на appuser
RUN chown -R appuser:appgroup /app

# Переключаемся на непривилегированного пользователя
USER appuser

EXPOSE 8080

# Оптимизированный запуск JVM
CMD ["java", "-XX:+UseContainerSupport", "-XX:MaxRAMPercentage=75.0", "-jar", "app.jar"]
