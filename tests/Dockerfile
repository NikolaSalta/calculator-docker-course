# ═══════════════════════════════════════════════════════════════════════════
# Dockerfile для тестов (pytest + Selenium)
# ═══════════════════════════════════════════════════════════════════════════
#
# Этот образ содержит:
# - Python 3.12
# - pytest и плагины
# - requests (для API-тестов)
# - selenium (для UI-тестов)
#
# Тесты запускаются внутри контейнера и подключаются к:
# - backend и frontend по сети Docker
# - Selenium Grid для управления браузером
# ═══════════════════════════════════════════════════════════════════════════


# Базовый образ: Python 3.12 на минимальном Alpine Linux
# python:3.12-slim — меньше чем полный образ, но больше чем alpine
# slim содержит необходимые библиотеки для большинства пакетов
FROM python:3.12-slim

# Устанавливаем рабочую директорию
# Все последующие команды выполняются отсюда
WORKDIR /tests

# ─────────────────────────────────────────────────────────────────────────────
# УСТАНОВКА ЗАВИСИМОСТЕЙ
# ─────────────────────────────────────────────────────────────────────────────

# Копируем файл зависимостей ОТДЕЛЬНО от остального кода
# Это оптимизация для кеширования Docker-слоёв:
# - Если requirements.txt не изменился → pip install берётся из кеша
# - Даже если изменились файлы тестов
COPY requirements.txt .

# Устанавливаем Python-пакеты
# --no-cache-dir — не сохранять pip cache (экономия места в образе)
RUN pip install --no-cache-dir -r requirements.txt

# ─────────────────────────────────────────────────────────────────────────────
# КОПИРОВАНИЕ ТЕСТОВ
# ─────────────────────────────────────────────────────────────────────────────

# Копируем конфигурацию pytest
COPY pytest.ini .

# Копируем Python-файлы тестов
COPY conftest.py .
COPY test_config.py .
COPY test_api.py .
COPY test_ui_selenium.py .

# ─────────────────────────────────────────────────────────────────────────────
# ПОДГОТОВКА ДИРЕКТОРИЙ
# ─────────────────────────────────────────────────────────────────────────────

# Создаём директорию для отчётов
# pytest-html будет сохранять HTML-отчёт сюда
# Через volume эта папка монтируется на хост
RUN mkdir -p /tests/reports

# ─────────────────────────────────────────────────────────────────────────────
# НАСТРОЙКИ ОКРУЖЕНИЯ
# ─────────────────────────────────────────────────────────────────────────────

# PYTHONUNBUFFERED=1 — отключить буферизацию вывода Python
# Без этого print() и логи могут не отображаться в docker logs
# Буферизация может задерживать вывод до заполнения буфера
ENV PYTHONUNBUFFERED=1

# ─────────────────────────────────────────────────────────────────────────────
# ЗАПУСК
# ─────────────────────────────────────────────────────────────────────────────

# ENTRYPOINT — базовая команда, которая всегда выполняется
# ["pytest"] — запустить pytest
#
# Отличие ENTRYPOINT от CMD:
# - ENTRYPOINT — "что запускать"
# - CMD — "с какими аргументами"
#
# docker run tests → запустит: pytest -v --html=...
# docker run tests -m smoke → запустит: pytest -m smoke
ENTRYPOINT ["pytest"]

# CMD — аргументы по умолчанию для ENTRYPOINT
# Эти аргументы можно переопределить при запуске контейнера
#
# -v — verbose (подробный вывод)
# --html=... — генерировать HTML-отчёт
# --self-contained-html — встроить CSS/JS в HTML (один файл)
CMD ["-v", "--html=/tests/reports/report.html", "--self-contained-html"]


# ═══════════════════════════════════════════════════════════════════════════
# ИСПОЛЬЗОВАНИЕ
# ═══════════════════════════════════════════════════════════════════════════
#
# Запустить все тесты (через compose):
#   docker compose -f docker-compose.test.yml up --build
#
# Запустить конкретные тесты:
#   docker compose -f docker-compose.test.yml run tests pytest -m smoke
#   docker compose -f docker-compose.test.yml run tests pytest -m api
#   docker compose -f docker-compose.test.yml run tests pytest test_api.py -v
#
# Отчёт будет в ./test-reports/report.html
# ═══════════════════════════════════════════════════════════════════════════
