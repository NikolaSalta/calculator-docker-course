# ═══════════════════════════════════════════════════════════════════════════
# Dockerfile.amd64 — тесты + браузер ВНУТРИ контейнера (x86_64 / Windows)
# ═══════════════════════════════════════════════════════════════════════════
#
# Этот Dockerfile предназначен для сборки под:
#   --platform linux/amd64
#
# Пример:
#   docker buildx build --platform linux/amd64 -f tests/Dockerfile.amd64 \
#     -t nikolaysaltan/calculator-docker-tests:amd64 --push tests
#
# Режим запуска:
# - USE_EMBEDDED_BROWSER=true  → webdriver.Chrome локально (Chromium внутри)
# - HEADLESS=true             → headless режим (по умолчанию)
# ═══════════════════════════════════════════════════════════════════════════

FROM python:3.12-slim-bookworm

LABEL maintainer="nikolaysaltan"
LABEL description="Calculator Docker Tests (AMD64) with embedded Chromium browser"
LABEL version="2.0-amd64"

WORKDIR /tests

# ─────────────────────────────────────────────────────────────────────────────
# Chromium + ChromeDriver (AMD64)
# ─────────────────────────────────────────────────────────────────────────────
RUN apt-get update && apt-get install -y --no-install-recommends \
    chromium \
    chromium-driver \
    fonts-liberation \
    fonts-noto-color-emoji \
    libnss3 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libdrm2 \
    libxkbcommon0 \
    libxcomposite1 \
    libxdamage1 \
    libxfixes3 \
    libxrandr2 \
    libgbm1 \
    libasound2 \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

RUN groupadd -r testuser && useradd -r -g testuser testuser

ENV CHROME_BIN=/usr/bin/chromium
ENV CHROMEDRIVER_PATH=/usr/bin/chromedriver
ENV USE_EMBEDDED_BROWSER=true
ENV HEADLESS=true
ENV PYTHONUNBUFFERED=1

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY pytest.ini .
COPY conftest.py .
COPY test_config.py .
COPY test_api.py .
COPY test_ui_selenium.py .

RUN mkdir -p /tests/reports && chown -R testuser:testuser /tests
USER testuser

ENTRYPOINT ["pytest"]
CMD ["-v", "--html=/tests/reports/report.html", "--self-contained-html"]


