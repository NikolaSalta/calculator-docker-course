# ═══════════════════════════════════════════════════════════════════════════
# Dockerfile.amd64 — Тесты (AMD64 / x86_64 / Windows/Linux) + встроенный Chromium
# ═══════════════════════════════════════════════════════════════════════════
#
# Отдельный Dockerfile для классической x86_64 архитектуры (Windows/Linux).
# Здесь используем Debian Bookworm slim (стабильнее для Chromium-зависимостей).
#
# Поддержка:
# - linux/amd64 (x86_64)
# ═══════════════════════════════════════════════════════════════════════════

# Легковесная база (как просили): slim
FROM python:3.12-slim

LABEL maintainer="nikolaysaltan"
LABEL description="Calculator Docker Tests (AMD64) with embedded Chromium"

WORKDIR /tests

# ─────────────────────────────────────────────────────────────────────────────
# Chromium + ChromeDriver (внутри контейнера)
# ─────────────────────────────────────────────────────────────────────────────
RUN apt-get update && apt-get install -y --no-install-recommends \
    chromium \
    chromium-driver \
    fonts-liberation \
    libnss3 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libdrm2 \
    libxkbcommon0 \
    libxcomposite1 \
    libxdamage1 \
    libxfixes3 \
    libxrandr2 \
    libgbm1 \
    libasound2 \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Запуск не от root
RUN groupadd -r testuser && useradd -r -g testuser testuser

ENV CHROME_BIN=/usr/bin/chromium
ENV CHROMEDRIVER_PATH=/usr/bin/chromedriver

# По умолчанию: используем REMOTE Selenium/noVNC (как уже настроено в проекте).
# Для встроенного браузера включите:
#   USE_EMBEDDED_BROWSER=true
ENV USE_EMBEDDED_BROWSER=false
ENV HEADLESS=true
ENV PYTHONUNBUFFERED=1

# Зависимости
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Тесты
COPY pytest.ini .
COPY conftest.py .
COPY test_config.py .
COPY test_api.py .
COPY test_ui_selenium.py .

RUN mkdir -p /tests/reports && chown -R testuser:testuser /tests

USER testuser

ENTRYPOINT ["pytest"]
CMD ["-v", "--html=/tests/reports/report.html", "--self-contained-html"]


