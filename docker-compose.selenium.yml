# ═══════════════════════════════════════════════════════════════════════════
# docker-compose.selenium.yml — Selenium с noVNC (ВИДИМЫЙ браузер!)
# ═══════════════════════════════════════════════════════════════════════════
#
# 🎬 ВИЗУАЛЬНОЕ ТЕСТИРОВАНИЕ
# ──────────────────────────────────────────────────────────────────────────
# Теперь вы можете ВИДЕТЬ, как браузер выполняет тесты!
#
# Откройте в браузере: http://localhost:7900
# Пароль: secret (или без пароля если SE_VNC_NO_PASSWORD=1)
#
# Что такое noVNC?
# ──────────────────────────────────────────────────────────────────────────
# VNC — протокол удалённого рабочего стола
# noVNC — VNC-клиент в браузере (не нужно устанавливать ПО)
#
# selenium/standalone-chrome имеет встроенный noVNC-сервер!
# Просто откройте http://localhost:7900 и смотрите тесты в реальном времени.
#
# Использование:
# ──────────────────────────────────────────────────────────────────────────
# 1. Запустить:
#    docker compose -f docker-compose.selenium.yml up --build
#
# 2. Открыть noVNC:
#    http://localhost:7900 (пароль: secret)
#
# 3. Смотреть тесты в реальном времени!
#
# 4. Отчёт после тестов:
#    http://localhost:9000/report.html (если запущен report-server)
# ═══════════════════════════════════════════════════════════════════════════

services:

  # ─────────────────────────────────────────────────────────────────────────
  # BACKEND — Java Spring Boot API
  # ─────────────────────────────────────────────────────────────────────────
  backend:
    build: ./backend
    container_name: calc-backend-selenium
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/api/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 30s

  # ─────────────────────────────────────────────────────────────────────────
  # FRONTEND — React + Nginx
  # ─────────────────────────────────────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.compose
    container_name: calc-frontend-selenium
    networks:
      - test-network
    depends_on:
      backend:
        condition: service_healthy

  # ─────────────────────────────────────────────────────────────────────────
  # SELENIUM CHROME — Браузер с VNC/noVNC
  # ─────────────────────────────────────────────────────────────────────────
  #
  # 🎬 ЭТО ГЛАВНОЕ ИЗМЕНЕНИЕ!
  #
  # Вместо selenium/hub + selenium/node-chrome используем standalone-chromium.
  # Он включает:
  # - Chromium браузер
  # - Selenium Server
  # - VNC сервер (порт 5900)
  # - noVNC веб-клиент (порт 7900)
  #
  # Теперь вы можете:
  # - Открыть http://localhost:7900 в браузере
  # - Видеть Chrome в реальном времени
  # - Наблюдать как тесты кликают кнопки, вводят текст
  #
  # ⚠️ Используем seleniarm для поддержки ARM (Apple Silicon M1/M2/M3)
  # ─────────────────────────────────────────────────────────────────────────
  selenium-chrome:
    # seleniarm — образы Selenium для ARM64 (Apple Silicon) и AMD64
    # Поддерживает: Mac M1/M2/M3, Linux ARM, обычные x86 серверы
    image: seleniarm/standalone-chromium:latest
    container_name: selenium-chrome-vnc
    
    # Больше памяти для Chrome
    shm_size: 2gb
    
    networks:
      - test-network
    
    # ═══════════════════════════════════════════════════════════════════════
    # ПОРТЫ для доступа извне Docker
    # ═══════════════════════════════════════════════════════════════════════
    ports:
      # 4444 — Selenium WebDriver (для тестов)
      - "4444:4444"
      
      # 7900 — noVNC (веб-интерфейс для просмотра браузера)
      # 🎬 Откройте http://localhost:7900 чтобы ВИДЕТЬ браузер!
      - "7900:7900"
      
      # 5900 — VNC (если хотите подключиться VNC-клиентом)
      - "5900:5900"
    
    # ═══════════════════════════════════════════════════════════════════════
    # ПЕРЕМЕННЫЕ ОКРУЖЕНИЯ
    # ═══════════════════════════════════════════════════════════════════════
    environment:
      # Максимум сессий (параллельных браузеров)
      - SE_NODE_MAX_SESSIONS=4
      - SE_NODE_OVERRIDE_MAX_SESSIONS=true
      
      # ─────────────────────────────────────────────────────────────────────
      # VNC НАСТРОЙКИ
      # ─────────────────────────────────────────────────────────────────────
      # SE_VNC_NO_PASSWORD=1 — без пароля (удобно для локальной разработки)
      # Если закомментировать — пароль будет "secret"
      # - SE_VNC_NO_PASSWORD=1
      
      # Размер экрана виртуального дисплея
      - SE_SCREEN_WIDTH=1920
      - SE_SCREEN_HEIGHT=1080
      - SE_SCREEN_DEPTH=24
      
      # Таймаут сессии (в секундах)
      - SE_SESSION_REQUEST_TIMEOUT=300
      - SE_SESSION_RETRY_INTERVAL=2

  # ─────────────────────────────────────────────────────────────────────────
  # TESTS — Контейнер с Python-тестами
  # ─────────────────────────────────────────────────────────────────────────
  tests:
    build: ./tests
    container_name: calc-tests-selenium
    networks:
      - test-network
    
    environment:
      # URL сервисов
      - BACKEND_URL=http://backend:8080
      - FRONTEND_URL=http://frontend:80
      
      # ═══════════════════════════════════════════════════════════════════
      # SELENIUM REMOTE URL
      # ═══════════════════════════════════════════════════════════════════
      # Теперь подключаемся напрямую к standalone-chrome (не через hub)
      - SELENIUM_REMOTE_URL=http://selenium-chrome:4444/wd/hub
      
      # Для обратной совместимости
      - SELENIUM_HUB_URL=http://selenium-chrome:4444
      
      # Какой браузер использовать
      - BROWSER=chrome
      
      # Увеличенное время ожидания
      - STARTUP_WAIT=90
      
      # ═══════════════════════════════════════════════════════════════════
      # HEADLESS MODE = OFF (видимый браузер!)
      # ═══════════════════════════════════════════════════════════════════
      # Эта переменная говорит тестам НЕ использовать headless режим
      - HEADLESS=false
    
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_started
      selenium-chrome:
        condition: service_started
    
    volumes:
      # Отчёты сохраняются на хосте
      - ./test-reports:/tests/reports
    
    # Запускаем все тесты
    command: [
      "-v",
      "-s",
      "--tb=short",
      "--html=/tests/reports/report.html",
      "--self-contained-html"
    ]

  # ─────────────────────────────────────────────────────────────────────────
  # REPORT-SERVER — HTTP-сервер для просмотра отчётов
  # ─────────────────────────────────────────────────────────────────────────
  report-server:
    image: nginx:alpine
    container_name: test-report-server
    networks:
      - test-network
    ports:
      - "9001:80"
    volumes:
      - ./test-reports:/usr/share/nginx/html:ro
    depends_on:
      - tests

# ═══════════════════════════════════════════════════════════════════════════
# NETWORKS
# ═══════════════════════════════════════════════════════════════════════════
networks:
  test-network:
    driver: bridge


# ═══════════════════════════════════════════════════════════════════════════
# 🎬 КАК ИСПОЛЬЗОВАТЬ ВИЗУАЛЬНОЕ ТЕСТИРОВАНИЕ
# ═══════════════════════════════════════════════════════════════════════════
#
# 1. ЗАПУСТИТЬ ТЕСТЫ:
#    docker compose -f docker-compose.selenium.yml up --build
#
# 2. ОТКРЫТЬ noVNC (СРАЗУ ПОСЛЕ ЗАПУСКА):
#    http://localhost:7900
#    Пароль: secret
#
# 3. НАБЛЮДАТЬ ЗА ТЕСТАМИ В РЕАЛЬНОМ ВРЕМЕНИ:
#    - Вы увидите рабочий стол Linux
#    - Chrome будет открываться автоматически
#    - Тесты будут кликать, вводить текст, проверять результаты
#
# 4. ПОСЛЕ ЗАВЕРШЕНИЯ — ОТЧЁТ:
#    http://localhost:9001/report.html
#
# ═══════════════════════════════════════════════════════════════════════════
