# ═══════════════════════════════════════════════════════════════════════════
# docker-compose.yml — Основной файл Docker Compose
# ═══════════════════════════════════════════════════════════════════════════
#
# Что такое Docker Compose?
# Docker Compose — инструмент для определения и запуска 
# многоконтейнерных Docker-приложений.
#
# Вместо выполнения множества команд docker run вручную,
# вы описываете всё в одном YAML-файле и запускаете одной командой:
#
#   docker compose up
#
# Что делает этот файл:
# 1. Определяет два сервиса: backend и frontend
# 2. Настраивает сборку образов из Dockerfile
# 3. Настраивает проброс портов
# 4. Создаёт сеть для связи между контейнерами
# 5. Определяет зависимости между сервисами
# ═══════════════════════════════════════════════════════════════════════════


# version — версия формата docker-compose.yml
# '3.8' — одна из последних версий с полным набором функций
# В Docker Compose v2+ версия опциональна, но для совместимости указываем
version: '3.8'


# ═══════════════════════════════════════════════════════════════════════════
# SERVICES — определение сервисов (контейнеров)
# ═══════════════════════════════════════════════════════════════════════════
#
# Каждый сервис — это один контейнер.
# Сервисы могут общаться друг с другом по именам.
# ═══════════════════════════════════════════════════════════════════════════
services:

  # ─────────────────────────────────────────────────────────────────────────
  # BACKEND SERVICE
  # ─────────────────────────────────────────────────────────────────────────
  #
  # "backend" — имя сервиса
  # Другие сервисы могут обращаться к нему по этому имени:
  # http://backend:8080
  # ─────────────────────────────────────────────────────────────────────────
  backend:
    
    # build: ./backend — собрать образ из Dockerfile в папке ./backend
    # Эквивалент: docker build ./backend
    build: ./backend
    
    # container_name — явное имя контейнера
    # Без этого Compose создаст имя вида: calculator-backend-1
    container_name: calc-backend
    
    # ports — проброс портов
    # Формат: "порт_хоста:порт_контейнера"
    # "8080:8080" означает:
    # - Запросы на localhost:8080 хоста
    # - Направляются на порт 8080 контейнера
    ports:
      - "8080:8080"
    
    # healthcheck — проверка здоровья контейнера
    # Docker периодически выполняет эту команду
    # Если она возвращает 0 — контейнер здоров
    # Если не 0 — контейнер нездоров
    healthcheck:
      # test — команда для проверки
      # wget делает HTTP-запрос на health endpoint
      # --spider — не скачивать файл, только проверить доступность
      # -q — тихий режим (без вывода)
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/api/health"]
      
      # interval — как часто проверять (каждые 10 секунд)
      interval: 10s
      
      # timeout — сколько ждать ответа
      timeout: 5s
      
      # retries — сколько неудачных попыток до статуса "unhealthy"
      retries: 3


  # ─────────────────────────────────────────────────────────────────────────
  # FRONTEND SERVICE
  # ─────────────────────────────────────────────────────────────────────────
  frontend:
    
    # build с расширенным синтаксисом
    # Используется когда нужно указать нестандартный Dockerfile
    build:
      # context — директория для сборки (откуда брать файлы)
      context: ./frontend
      
      # dockerfile — имя Dockerfile (если не стандартное)
      # Dockerfile.compose использует nginx.compose.conf
      # где proxy_pass указывает на "backend" (имя сервиса)
      dockerfile: Dockerfile.compose
    
    container_name: calc-frontend
    
    # Проброс порта: localhost:3000 → контейнер:8080
    ports:
      - "3000:8080"
    
    # depends_on — зависимость от других сервисов
    # frontend запустится ПОСЛЕ backend
    #
    # ВАЖНО: depends_on НЕ ждёт, пока backend будет готов принимать запросы!
    # Он только гарантирует порядок запуска контейнеров.
    # Для ожидания готовности используйте healthcheck + condition
    depends_on:
      - backend


# ═══════════════════════════════════════════════════════════════════════════
# ИСПОЛЬЗОВАНИЕ
# ═══════════════════════════════════════════════════════════════════════════
#
# Запустить всё:
#   docker compose up --build -d
#
# Посмотреть статус:
#   docker compose ps
#
# Посмотреть логи:
#   docker compose logs -f
#
# Остановить и удалить:
#   docker compose down
#
# Пересобрать один сервис:
#   docker compose build backend
#   docker compose up -d backend
#
# Масштабирование (несколько копий):
#   docker compose up -d --scale backend=3
# ═══════════════════════════════════════════════════════════════════════════
