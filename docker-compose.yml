# ═══════════════════════════════════════════════════════════════════════════
# docker-compose.yml — Основной файл Docker Compose
# ═══════════════════════════════════════════════════════════════════════════
#
# УЛУЧШЕНИЯ:
# - Убрана устаревшая директива version
# - Добавлен depends_on с condition: service_healthy
# - Изменён порт frontend на 3001 (избежание конфликта с Grafana)
# - Добавлены ограничения ресурсов
# ═══════════════════════════════════════════════════════════════════════════


# ═══════════════════════════════════════════════════════════════════════════
# SERVICES — определение сервисов (контейнеров)
# ═══════════════════════════════════════════════════════════════════════════
services:

  # ─────────────────────────────────────────────────────────────────────────
  # BACKEND SERVICE
  # ─────────────────────────────────────────────────────────────────────────
  backend:
    build: ./backend
    container_name: calc-backend
    
    ports:
      - "8080:8080"
    
    # Healthcheck для проверки готовности сервиса
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s  # Даём время на запуск Spring Boot
    
    # Ограничения ресурсов (защита от утечек памяти)
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    
    # Переменные окружения
    environment:
      - JAVA_OPTS=-Xmx384m -Xms128m


  # ─────────────────────────────────────────────────────────────────────────
  # FRONTEND SERVICE
  # ─────────────────────────────────────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.compose
    
    container_name: calc-frontend
    
    # Порты:
    # - 3001:80 — веб-приложение (nginx)
    # - 5901:5901 — VNC сервер (для прямого подключения)
    # - 7900:6080 — noVNC (веб-доступ к браузеру)
    ports:
      - "3001:80"
      - "5901:5901"
      - "7900:6080"
    
    # УЛУЧШЕНИЕ: Ждём пока backend станет healthy
    depends_on:
      backend:
        condition: service_healthy
    
    # Ограничения ресурсов (увеличено для браузера)
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M


# ═══════════════════════════════════════════════════════════════════════════
# ИСПОЛЬЗОВАНИЕ
# ═══════════════════════════════════════════════════════════════════════════
#
# Запустить всё:
#   docker compose up --build -d
#
# Посмотреть статус:
#   docker compose ps
#
# Посмотреть логи:
#   docker compose logs -f
#
# Остановить и удалить:
#   docker compose down
# ═══════════════════════════════════════════════════════════════════════════
