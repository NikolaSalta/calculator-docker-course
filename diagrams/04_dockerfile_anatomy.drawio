<mxfile host="app.diagrams.net">
  <diagram name="04 - Анатомия Dockerfile" id="dockerfile-anatomy">
    <mxGraphModel dx="1434" dy="780" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="1400">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        
        <!-- Заголовок -->
        <mxCell id="title" value="&lt;h1&gt;ДИАГРАММА 4: Анатомия Dockerfile&lt;/h1&gt;&lt;p&gt;Разбор каждой инструкции и её влияния на образ&lt;/p&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;" vertex="1" parent="1">
          <mxGeometry x="350" y="20" width="700" height="60" as="geometry" />
        </mxCell>
        
        <!-- Backend Dockerfile -->
        <mxCell id="backend-section" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="50" y="100" width="700" height="600" as="geometry" />
        </mxCell>
        <mxCell id="backend-title" value="&lt;b&gt;BACKEND DOCKERFILE (Multi-stage build)&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;" vertex="1" parent="1">
          <mxGeometry x="50" y="105" width="700" height="25" as="geometry" />
        </mxCell>
        
        <!-- Stage 1 -->
        <mxCell id="stage1" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="70" y="140" width="320" height="280" as="geometry" />
        </mxCell>
        <mxCell id="stage1-title" value="&lt;b&gt;STAGE 1: BUILDER&lt;/b&gt;&lt;br&gt;(Сборка приложения)" style="text;html=1;strokeColor=none;fillColor=none;align=center;" vertex="1" parent="1">
          <mxGeometry x="70" y="145" width="320" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="from1" value="&lt;b&gt;FROM&lt;/b&gt; maven:3.9-eclipse-temurin-17 AS builder" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=5;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="80" y="180" width="300" height="30" as="geometry" />
        </mxCell>
        <mxCell id="from1-exp" value="Базовый образ: Maven + JDK 17&lt;br&gt;~400 MB, содержит компилятор" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="85" y="210" width="290" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="workdir1" value="&lt;b&gt;WORKDIR&lt;/b&gt; /app" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=5;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="80" y="245" width="300" height="25" as="geometry" />
        </mxCell>
        <mxCell id="workdir1-exp" value="Создать и перейти в /app" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="85" y="270" width="290" height="15" as="geometry" />
        </mxCell>
        
        <mxCell id="copy1" value="&lt;b&gt;COPY&lt;/b&gt; pom.xml ." style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=5;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="80" y="290" width="300" height="25" as="geometry" />
        </mxCell>
        <mxCell id="copy1-exp" value="Копировать pom.xml (зависимости)" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="85" y="315" width="290" height="15" as="geometry" />
        </mxCell>
        
        <mxCell id="copy2" value="&lt;b&gt;COPY&lt;/b&gt; src ./src" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=5;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="80" y="335" width="300" height="25" as="geometry" />
        </mxCell>
        <mxCell id="copy2-exp" value="Копировать исходный код" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="85" y="360" width="290" height="15" as="geometry" />
        </mxCell>
        
        <mxCell id="run1" value="&lt;b&gt;RUN&lt;/b&gt; mvn clean package -DskipTests" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;spacingLeft=5;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="80" y="380" width="300" height="25" as="geometry" />
        </mxCell>
        <mxCell id="run1-exp" value="Компилировать Java → JAR" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="85" y="405" width="290" height="15" as="geometry" />
        </mxCell>
        
        <!-- Stage 2 -->
        <mxCell id="stage2" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="410" y="140" width="320" height="280" as="geometry" />
        </mxCell>
        <mxCell id="stage2-title" value="&lt;b&gt;STAGE 2: RUNTIME&lt;/b&gt;&lt;br&gt;(Минимальный образ)" style="text;html=1;strokeColor=none;fillColor=none;align=center;" vertex="1" parent="1">
          <mxGeometry x="410" y="145" width="320" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="from2" value="&lt;b&gt;FROM&lt;/b&gt; eclipse-temurin:17-jre-alpine" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=5;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="420" y="180" width="300" height="30" as="geometry" />
        </mxCell>
        <mxCell id="from2-exp" value="Только JRE (без компилятора)&lt;br&gt;Alpine = минимальный Linux (~150 MB)" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="425" y="210" width="290" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="workdir2" value="&lt;b&gt;WORKDIR&lt;/b&gt; /app" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=5;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="420" y="245" width="300" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="copy3" value="&lt;b&gt;COPY --from=builder&lt;/b&gt; /app/target/*.jar app.jar" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=5;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="420" y="280" width="300" height="30" as="geometry" />
        </mxCell>
        <mxCell id="copy3-exp" value="Копировать JAR из stage 1!&lt;br&gt;--from=builder ссылается на первый stage" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="425" y="310" width="290" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="expose1" value="&lt;b&gt;EXPOSE&lt;/b&gt; 8080" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;align=left;spacingLeft=5;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="420" y="345" width="300" height="25" as="geometry" />
        </mxCell>
        <mxCell id="expose1-exp" value="Документация: приложение использует порт 8080" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="425" y="370" width="290" height="15" as="geometry" />
        </mxCell>
        
        <mxCell id="cmd1" value="&lt;b&gt;CMD&lt;/b&gt; [&quot;java&quot;, &quot;-jar&quot;, &quot;app.jar&quot;]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=5;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="420" y="390" width="300" height="25" as="geometry" />
        </mxCell>
        <mxCell id="cmd1-exp" value="Команда при запуске контейнера" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="425" y="415" width="290" height="15" as="geometry" />
        </mxCell>
        
        <!-- Arrow between stages -->
        <mxCell id="stage-arrow" value="Копируем только JAR" style="endArrow=classic;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.5;strokeWidth=2;strokeColor=#82b366;" edge="1" parent="1" source="stage1" target="stage2">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- Size comparison -->
        <mxCell id="size-compare" value="&lt;b&gt;РАЗМЕР ОБРАЗА&lt;/b&gt;&lt;br&gt;&lt;br&gt;Без multi-stage: ~500 MB&lt;br&gt;(Maven + JDK + исходники)&lt;br&gt;&lt;br&gt;С multi-stage: ~150 MB&lt;br&gt;(Только JRE + JAR)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="70" y="450" width="200" height="120" as="geometry" />
        </mxCell>
        
        <!-- Layers explanation -->
        <mxCell id="layers-title" value="&lt;b&gt;КАК ОБРАЗУЮТСЯ СЛОИ&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;" vertex="1" parent="1">
          <mxGeometry x="70" y="590" width="660" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="layer-stack" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="300" y="450" width="430" height="130" as="geometry" />
        </mxCell>
        
        <mxCell id="l1" value="Layer 5: CMD (metadata)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="310" y="460" width="180" height="20" as="geometry" />
        </mxCell>
        <mxCell id="l2" value="Layer 4: EXPOSE (metadata)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="310" y="485" width="180" height="20" as="geometry" />
        </mxCell>
        <mxCell id="l3" value="Layer 3: COPY app.jar (10 MB)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="310" y="510" width="180" height="20" as="geometry" />
        </mxCell>
        <mxCell id="l4" value="Layer 2: WORKDIR" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="310" y="535" width="180" height="20" as="geometry" />
        </mxCell>
        <mxCell id="l5" value="Layer 1: FROM base image (140 MB)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="310" y="560" width="180" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="layer-note" value="• Каждая инструкция = слой&lt;br&gt;• Слои кешируются&lt;br&gt;• Изменился файл → пересборка слоя и всех выше&lt;br&gt;• Порядок COPY важен для кеширования!" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="510" y="460" width="210" height="80" as="geometry" />
        </mxCell>
        
        <!-- Frontend explanation -->
        <mxCell id="frontend-section" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="800" y="100" width="450" height="600" as="geometry" />
        </mxCell>
        <mxCell id="frontend-title" value="&lt;b&gt;FRONTEND DOCKERFILE&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;" vertex="1" parent="1">
          <mxGeometry x="800" y="105" width="450" height="25" as="geometry" />
        </mxCell>
        
        <!-- Frontend Stage 1 -->
        <mxCell id="fe-stage1" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="820" y="140" width="410" height="180" as="geometry" />
        </mxCell>
        <mxCell id="fe-stage1-title" value="&lt;b&gt;STAGE 1: NODE BUILD&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;" vertex="1" parent="1">
          <mxGeometry x="820" y="145" width="410" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="fe-from1" value="FROM node:20-alpine AS builder" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="830" y="170" width="200" height="20" as="geometry" />
        </mxCell>
        <mxCell id="fe-copy1" value="COPY package*.json ./" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="830" y="195" width="200" height="20" as="geometry" />
        </mxCell>
        <mxCell id="fe-run1" value="RUN npm install" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="830" y="220" width="200" height="20" as="geometry" />
        </mxCell>
        <mxCell id="fe-copy2" value="COPY public ./public" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="830" y="245" width="200" height="20" as="geometry" />
        </mxCell>
        <mxCell id="fe-copy3" value="COPY src ./src" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="830" y="270" width="200" height="20" as="geometry" />
        </mxCell>
        <mxCell id="fe-run2" value="RUN npm run build" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="830" y="295" width="200" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="fe-note1" value="Компилирует React в&lt;br&gt;статические файлы&lt;br&gt;(HTML, CSS, JS)" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="1050" y="220" width="170" height="50" as="geometry" />
        </mxCell>
        
        <!-- Frontend Stage 2 -->
        <mxCell id="fe-stage2" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="820" y="340" width="410" height="150" as="geometry" />
        </mxCell>
        <mxCell id="fe-stage2-title" value="&lt;b&gt;STAGE 2: NGINX&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;" vertex="1" parent="1">
          <mxGeometry x="820" y="345" width="410" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="fe-from2" value="FROM nginx:alpine" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="830" y="370" width="200" height="20" as="geometry" />
        </mxCell>
        <mxCell id="fe-copy4" value="COPY --from=builder /app/build /usr/share/nginx/html" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="830" y="395" width="300" height="20" as="geometry" />
        </mxCell>
        <mxCell id="fe-copy5" value="COPY nginx.conf /etc/nginx/conf.d/default.conf" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="830" y="420" width="300" height="20" as="geometry" />
        </mxCell>
        <mxCell id="fe-cmd" value="CMD [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="830" y="445" width="200" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="fe-note2" value="nginx:alpine = 25 MB&lt;br&gt;+ React build = ~20 MB&lt;br&gt;&lt;br&gt;Итого: ~45 MB" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="1050" y="380" width="170" height="60" as="geometry" />
        </mxCell>
        
        <!-- Legend -->
        <mxCell id="legend" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="820" y="510" width="410" height="170" as="geometry" />
        </mxCell>
        <mxCell id="legend-title" value="&lt;b&gt;ЛЕГЕНДА ИНСТРУКЦИЙ&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;" vertex="1" parent="1">
          <mxGeometry x="820" y="515" width="410" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="leg-from" value="FROM — базовый образ" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="835" y="540" width="180" height="20" as="geometry" />
        </mxCell>
        <mxCell id="leg-copy" value="COPY — копировать файлы" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="835" y="565" width="180" height="20" as="geometry" />
        </mxCell>
        <mxCell id="leg-run" value="RUN — выполнить команду" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="835" y="590" width="180" height="20" as="geometry" />
        </mxCell>
        <mxCell id="leg-workdir" value="WORKDIR — рабочая директория" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="835" y="615" width="180" height="20" as="geometry" />
        </mxCell>
        <mxCell id="leg-cmd" value="CMD — команда при запуске" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="835" y="640" width="180" height="20" as="geometry" />
        </mxCell>
        <mxCell id="leg-expose" value="EXPOSE — документация порта" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="835" y="665" width="180" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="leg-note" value="&lt;b&gt;Порядок важен!&lt;/b&gt;&lt;br&gt;&lt;br&gt;1. Сначала редко меняющиеся&lt;br&gt;2. Потом часто меняющиеся&lt;br&gt;&lt;br&gt;Так кеш работает эффективнее" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="1030" y="540" width="180" height="100" as="geometry" />
        </mxCell>
        
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
