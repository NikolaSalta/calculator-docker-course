# ═══════════════════════════════════════════════════════════════════════════
# docker-compose.all.yml — Единый файл для всех контейнеров
# ═══════════════════════════════════════════════════════════════════════════
#
# Этот файл включает все три контейнера: backend, frontend и tests.
# Все контейнеры собираются одновременно при запуске.
#
# Использование:
#   # Запустить все контейнеры (без тестов):
#   docker compose -f docker-compose.all.yml up --build -d
#
#   # Запустить все включая тесты:
#   docker compose -f docker-compose.all.yml up --build
#
#   # Запустить только тесты вручную:
#   docker compose -f docker-compose.all.yml run --rm tests pytest -v
#
#   # Пересобрать все контейнеры:
#   docker compose -f docker-compose.all.yml build --no-cache
#
# ═══════════════════════════════════════════════════════════════════════════

services:

  # ─────────────────────────────────────────────────────────────────────────
  # BACKEND SERVICE
  # ─────────────────────────────────────────────────────────────────────────
  backend:
    build: ./backend
    container_name: calc-backend
    
    ports:
      - "8080:8080"
    
    # Healthcheck для проверки готовности сервиса
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s  # Даём время на запуск Spring Boot
    
    # Ограничения ресурсов (защита от утечек памяти)
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    
    # Переменные окружения
    environment:
      - JAVA_OPTS=-Xmx384m -Xms128m


  # ─────────────────────────────────────────────────────────────────────────
  # FRONTEND SERVICE
  # ─────────────────────────────────────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.compose
    
    container_name: calc-frontend
    
    # Порты:
    # - 3001:80 — веб-приложение (nginx)
    # - 5901:5901 — VNC сервер (для прямого подключения)
    # - 7900:6080 — noVNC (веб-доступ к браузеру)
    ports:
      - "3001:80"
      - "5901:5901"
      - "7900:6080"
    
    # Ждём пока backend станет healthy
    depends_on:
      backend:
        condition: service_healthy
    
    # Ограничения ресурсов (увеличено для браузера)
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M


  # ─────────────────────────────────────────────────────────────────────────
  # TESTS — контейнер с тестами
  # ─────────────────────────────────────────────────────────────────────────
  tests:
    build: ./tests
    container_name: calc-tests
    
    # environment — переменные окружения для тестов
    environment:
      # URL backend-сервиса (имя сервиса в compose)
      - BACKEND_URL=http://backend:8080
      
      # URL frontend-сервиса
      - FRONTEND_URL=http://frontend:80
      
      # Сколько секунд ждать готовности сервисов
      - STARTUP_WAIT=60
      
      # Использовать встроенный браузер (Chromium внутри контейнера)
      # Это позволяет запускать тесты без дополнительного Selenium Grid
      - USE_EMBEDDED_BROWSER=true
      
      # Headless режим (без GUI)
      - HEADLESS=true
    
    # depends_on — тесты запускаются после готовности приложения
    depends_on:
      backend:
        condition: service_healthy   # Ждём пока backend станет healthy
      frontend:
        condition: service_started   # Frontend достаточно просто запустить
    
    # volumes — подключение директорий хоста к контейнеру
    volumes:
      - ./test-reports:/tests/reports
    
    # Тесты собираются вместе с остальными контейнерами,
    # но НЕ запускаются автоматически при docker compose up -d
    # Для запуска тестов используйте:
    #   docker compose -f docker-compose.all.yml run --rm tests pytest -v
    # Или запустите все контейнеры включая тесты:
    #   docker compose -f docker-compose.all.yml up --build


# ═══════════════════════════════════════════════════════════════════════════
# ИСПОЛЬЗОВАНИЕ
# ═══════════════════════════════════════════════════════════════════════════
#
# Запустить backend и frontend (без тестов):
#   docker compose -f docker-compose.all.yml up --build -d
#
# Запустить все включая тесты (тесты запустятся автоматически):
#   docker compose -f docker-compose.all.yml up --build
#
# Запустить только тесты вручную (когда backend и frontend уже запущены):
#   docker compose -f docker-compose.all.yml run --rm tests pytest -v -m "smoke or api"
#
# Пересобрать все контейнеры:
#   docker compose -f docker-compose.all.yml build --no-cache
#
# Посмотреть статус:
#   docker compose -f docker-compose.all.yml ps
#
# Остановить все:
#   docker compose -f docker-compose.all.yml down
# ═══════════════════════════════════════════════════════════════════════════

